<html>
  <head>
    <title>Hello, transition!</title>
    <script type="text/javascript" src="../../epheme.js"></script>
  </head>
  <body>
    Your lucky numbers are:<br>
    <script type="text/javascript">

var eo = org.epheme;

// TODO would like a better way to track identifiers and indexes.

var data = [
  {id: 0, index: 0, value: 4},
  {id: 1, index: 1, value: 8},
  {id: 2, index: 2, value: 15},
  {id: 3, index: 3, value: 16},
  {id: 4, index: 4, value: 23},
  {id: 5, index: 5, value: 42}
];

var n = data.length,
    h = 60;

eo.select("//body").add("svg:svg")
    .style("padding-left", "5%")
    .style("padding-right", "5%")
    .attr("width", "90%")
    .attr("height", h * n);

var map = eo.map(data)
    .by(function(d) { return "id('lucky-" + d.id + "')"; })
    .from("//svg:g")
    .on("enter", enter)
    .on("exit", exit)
    .on("update", update)
    .apply();

function enter(e) {
  var g = e.target.select("//svg:svg").add("svg:g")
      .attr("id", function(d) { return "lucky-" + d.id; })
      .attr("transform", function(d) { return "translate(0," + d.index * h + ")"; });

  g.add("svg:text")
      .attr("x", "-15%")
      .attr("y", h / 2)
      .attr("dy", ".35em")
      .attr("text-anchor", "middle")
      .attr("fill", function(d) { return d.value < 50 ? "steelblue" : "brown"; })
      .style("font", "32pt Helvetica Neue")
      .style("font-weight", 300)
      .text(function(d) { return d.value; });

  g.transition()
      .duration(1000)
      .ease("elastic")
    .select("svg:text")
      .attr("x", function(d) { return d.value + "%"; });
}

function update(e) {
  e.target.transition()
      .duration(1000)
      .ease("elastic")
      .attr("transform", function(d) { return "translate(0," + d.index * h + ")"; });
}

function exit(e) {
  e.target.transition()
      .duration(1000)
      .ease("elastic")
      .on("end", function() { e.target.remove(); })
    .select("svg:text")
      .attr("x", "115%");
}

function refresh() {
  data.shift();
  data.push({id: Date.now(), value: ~~(Math.random() * 100)});
  for (var i = 0; i < data.length; i++) data[i].index = i;
  map.apply();
}

setInterval(refresh, 1000);

    </script>
  </body>
</html>
